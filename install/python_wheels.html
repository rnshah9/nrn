<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Building Python Wheels &mdash; NEURON  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/design-tabs.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Code Coverage" href="code_coverage.html" />
    <link rel="prev" title="Mac Binary Package (Apple M1 and Mac x86_64)" href="mac_pkg.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> NEURON
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Building:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake_doc/index.html">CMake Build Options</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer Builds</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mac_pkg.html">Mac Binary Package (Apple M1 and Mac x86_64)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building Python Wheels</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#linux-wheels">Linux wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-docker">Setting up Docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#neuron-docker-image-workflow">NEURON Docker Image Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-the-docker-image">Building the docker image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pushing-to-dockerhub">Pushing to DockerHub</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-docker-image">Using the docker image</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mpi-support">MPI support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#macos-wheels">macOS wheels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#launch-the-wheel-building">Launch the wheel building</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#linux">Linux</a></li>
<li class="toctree-l4"><a class="reference internal" href="#macos">macOS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-wheels">Testing the wheels</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#macos-considerations">MacOS considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-on-bb5">Testing on BB5</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-the-wheels-on-pypi-via-azure">Publishing the wheels on Pypi via Azure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#official-release-wheels">Official Release wheels</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#publishing-the-wheels-on-pypi-via-circleci">Publishing the wheels on Pypi via CircleCI</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nightly-wheels">Nightly wheels</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="code_coverage.html">Code Coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html">Diagnosis and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug.html#profiling-and-performance-benchmarking">Profiling and performance benchmarking</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../videos/index.html">Training videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../courses/exercises2018.html">NEURON Course Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications about NEURON</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications-using-neuron.html">Publications using NEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NEURON scripting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hoc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../otherscripting.html">Other scripting languages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rxd-tutorials/index.html">Python RXD tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coreneuron/index.html">CoreNEURON</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C/C++ API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Removed Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../removed_features.html">Removed Features</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">NEURON 8.1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#neuron-8-0">NEURON 8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#contributors">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html#feedback-help">Feedback / Help</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEURON</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="developer.html">Developer Builds</a> &raquo;</li>
      <li>Building Python Wheels</li>
<li class="wy-breadcrumbs-aside">
    
    
</li>

      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/install/python_wheels.md.txt" rel="nofollow"> View page source</a>
      </li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="building-python-wheels">
<h1>Building Python Wheels<a class="headerlink" href="#building-python-wheels" title="Permalink to this headline"></a></h1>
<div class="section" id="linux-wheels">
<h2>Linux wheels<a class="headerlink" href="#linux-wheels" title="Permalink to this headline"></a></h2>
<p>In order to have NEURON binaries run on most Linux distros, we rely on the <a class="reference external" href="https://github.com/pypa/manylinux">manylinux project</a>.
Current NEURON Linux image is based on <code class="docutils literal notranslate"><span class="pre">manylinux2014</span></code>.</p>
<div class="section" id="setting-up-docker">
<h3>Setting up Docker<a class="headerlink" href="#setting-up-docker" title="Permalink to this headline"></a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Docker_(software)">Docker</a> is required for building Linux wheels.
You can find instructions on how to setup Docker on Linux <a class="reference external" href="https://docs.docker.com/engine/install/">here</a>.</p>
</div>
<div class="section" id="neuron-docker-image-workflow">
<h3>NEURON Docker Image Workflow<a class="headerlink" href="#neuron-docker-image-workflow" title="Permalink to this headline"></a></h3>
<p>When required (i.e. update packages, add new software), <code class="docutils literal notranslate"><span class="pre">NEURON</span> <span class="pre">maintainers</span></code> are in charge of updating the NEURON docker
images published on Docker Hub under:</p>
<ul class="simple">
<li><a class="reference external" href="https://hub.docker.com/r/neuronsimulator/neuron_wheel">neuronsimulator/neuron_wheel</a></li>
<li><a class="reference external" href="https://hub.docker.com/r/neuronsimulator/neuron_wheel_gpu">neuronsimulator/neuron_wheel_gpu</a></li>
</ul>
<p>Azure pipelines pull this image off DockerHub for Linux wheels building.</p>
<p>Updating and publishing the public images are done by a manual process that relies on a <code class="docutils literal notranslate"><span class="pre">Docker</span> <span class="pre">file</span></code>
(see <a class="reference external" href="../../packaging/python/Dockerfile">packaging/python/Dockerfile</a> and <a class="reference external" href="../../packaging/python/Dockerfile_gpu">packaging/python/Dockerfile_gpu</a>).
Any official update of these files shall imply a PR reviewed and merged before <code class="docutils literal notranslate"><span class="pre">DockerHub</span></code> publishing.</p>
<p>All wheels built on Azure are:</p>
<ul class="simple">
<li>Published to <code class="docutils literal notranslate"><span class="pre">Pypi.org</span></code> as<ul>
<li><code class="docutils literal notranslate"><span class="pre">neuron-nightly</span></code> -&gt; when the pipeline is launched in CRON mode</li>
<li><code class="docutils literal notranslate"><span class="pre">neuron-x.y.z</span></code> -&gt; when the pipeline is manually triggered for release <code class="docutils literal notranslate"><span class="pre">x.y.z</span></code></li>
<li>additionally, for Linux only: <code class="docutils literal notranslate"><span class="pre">neuron-gpu-nightly</span></code> and <code class="docutils literal notranslate"><span class="pre">neuron-gpu-x.y.z</span></code></li>
</ul>
</li>
<li>Stored as <code class="docutils literal notranslate"><span class="pre">Azure</span> <span class="pre">artifacts</span></code> in the Azure pipeline for every run.</li>
</ul>
<p>Refer to the following image for the NEURON Docker Image workflow:
<img alt="../_images/docker-workflow.png" src="../_images/docker-workflow.png" /></p>
</div>
<div class="section" id="building-the-docker-image">
<h3>Building the docker image<a class="headerlink" href="#building-the-docker-image" title="Permalink to this headline"></a></h3>
<p>After making updates to any of the docker files, you can build the image with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">nrn</span><span class="o">/</span><span class="n">packaging</span><span class="o">/</span><span class="n">python</span>
<span class="c1"># update Dockerfile</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">[</span><span class="n">_gpu</span><span class="p">]:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span> <span class="o">.</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;tag&gt;</span></code> is:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">latest-x86_64</span></code> or <code class="docutils literal notranslate"><span class="pre">latest-aarch64</span></code> for official publishing on respective platforms (after merging related PR)</li>
<li><code class="docutils literal notranslate"><span class="pre">feature-name</span></code> for updates (for local testing or for PR testing purposes where you can temporarily publish the tag on DockerHub and tweak Azure CI pipelines to use it - refer to
<code class="docutils literal notranslate"><span class="pre">Job:</span> <span class="pre">'ManyLinuxWheels'</span></code> or <code class="docutils literal notranslate"><span class="pre">Job:</span> <span class="pre">'ManyLinuxGPUWheels'</span></code> in <a class="reference external" href="../../azure-pipelines.yml">azure-pipelines.yml</a> )</li>
</ul>
<p>and <code class="docutils literal notranslate"><span class="pre">_gpu</span></code> is needed for the GPU wheel.</p>
<p>If you are building an image for AArch64 i.e. with <code class="docutils literal notranslate"><span class="pre">latest-aarch64</span></code> tag then you additionally pass <code class="docutils literal notranslate"><span class="pre">--build-arg</span></code> argument to docker build command in order to use compatible manylinux image for ARM64 platform (e.g. while building on Apple M1 or QEMU emulation):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">:</span><span class="n">latest</span><span class="o">-</span><span class="n">aarch64</span> <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">arg</span> <span class="n">MANYLINUX_IMAGE</span><span class="o">=</span><span class="n">manylinux2014_aarch64</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="pushing-to-dockerhub">
<h3>Pushing to DockerHub<a class="headerlink" href="#pushing-to-dockerhub" title="Permalink to this headline"></a></h3>
<p>In order to push the image and its tag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">login</span> <span class="o">--</span><span class="n">username</span><span class="o">=&lt;</span><span class="n">username</span><span class="o">&gt;</span>
<span class="n">docker</span> <span class="n">push</span> <span class="n">neuronsimulator</span><span class="o">/</span><span class="n">neuron_wheel</span><span class="p">[</span><span class="n">_gpu</span><span class="p">]:</span><span class="o">&lt;</span><span class="n">tag</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-docker-image">
<h3>Using the docker image<a class="headerlink" href="#using-the-docker-image" title="Permalink to this headline"></a></h3>
<p>You can either build the neuron images locally or pull them from DockerHub:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker pull neuronsimulator/neuron_wheel
Using default tag: latest
latest: Pulling from neuronsimulator/neuron_wheel
....
Status: Downloaded newer image for neuronsimulator/neuron_wheel:latest
docker.io/neuronsimulator/neuron_wheel:latest
</pre></div>
</div>
<p>We can conveniently mount the local NEURON repository inside docker, by using the <code class="docutils literal notranslate"><span class="pre">-v</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -v $PWD/nrn:/root/nrn -w /root/nrn -it neuronsimulator/neuron_wheel bash
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$PWD/nrn</span></code> is a NEURON repository on the host machine that ends up mounted at <code class="docutils literal notranslate"><span class="pre">/root/nrn</span></code>.
This is how you can test your NEURON updates inside the NEURON Docker image.
Note that <code class="docutils literal notranslate"><span class="pre">-w</span></code> sets the working directory inside the container.</p>
<p>If you want to build wheels with <code class="docutils literal notranslate"><span class="pre">GPU</span> <span class="pre">support</span></code> via CoreNEURON, then you have to use the <code class="docutils literal notranslate"><span class="pre">neuronsimulator/neuron_wheel_gpu</span></code> image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -v $PWD/nrn:/root/nrn -w /root/nrn -it neuronsimulator/neuron_wheel_gpu bash
</pre></div>
</div>
</div>
<div class="section" id="mpi-support">
<h3>MPI support<a class="headerlink" href="#mpi-support" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">neuronsimulator/neuron_wheel</span></code> provides out-of-the-box support for <code class="docutils literal notranslate"><span class="pre">mpich</span></code> and <code class="docutils literal notranslate"><span class="pre">openmpi</span></code>.
For <code class="docutils literal notranslate"><span class="pre">HPE-MPT</span> <span class="pre">MPI</span></code>, since it’s not open source, you need to acquire the headers and mount them in the docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -v $PWD/nrn:/root/nrn -w /root/nrn -v $PWD/mpt-headers/2.21/include:/nrnwheel/mpt/include -it neuronsimulator/neuron_wheel bash
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$PWD/mpt-headers</span></code> is the path to the HPE-MPT MPI headers on the host machine that end up mounted at <code class="docutils literal notranslate"><span class="pre">/nrnwheel/mpt/include</span></code>.
You can download the headers with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">ssh</span><span class="p">:</span><span class="o">//</span><span class="n">bbpcode</span><span class="o">.</span><span class="n">epfl</span><span class="o">.</span><span class="n">ch</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">kumbhar</span><span class="o">/</span><span class="n">mpt</span><span class="o">-</span><span class="n">headers</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="macos-wheels">
<h2>macOS wheels<a class="headerlink" href="#macos-wheels" title="Permalink to this headline"></a></h2>
<p>Note that for macOS there is no docker image needed, but all required dependencies must exist.
In order to have the wheels working on multiple macOS target versions, special consideration must be made for <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET</span></code>.</p>
<p>Taking Azure macOS <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> wheels for example, <code class="docutils literal notranslate"><span class="pre">readline</span></code> was built with <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=10.9</span></code> and stored as secure file on Azure.
For <code class="docutils literal notranslate"><span class="pre">arm64</span></code> we need to set <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=11.0</span></code>. The wheels currently need to be built manually, using <code class="docutils literal notranslate"><span class="pre">universal2</span></code> Python installers.
For upcoming <code class="docutils literal notranslate"><span class="pre">universal2</span></code> wheels (targeting both <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> and <code class="docutils literal notranslate"><span class="pre">arm64</span></code>) we will consider leveling everything to <code class="docutils literal notranslate"><span class="pre">MACOSX_DEPLOYMENT_TARGET=11.0</span></code>.</p>
<p>You can use <a class="reference external" href="../../packaging/python/build_static_readline_osx.bash">packaging/python/build_static_readline_osx.bash</a> to build a static readline library.
You can have a look at the script for requirements and usage.</p>
</div>
<div class="section" id="launch-the-wheel-building">
<h2>Launch the wheel building<a class="headerlink" href="#launch-the-wheel-building" title="Permalink to this headline"></a></h2>
<div class="section" id="linux">
<h3>Linux<a class="headerlink" href="#linux" title="Permalink to this headline"></a></h3>
<p>Once we’ve cloned and mounted NEURON inside Docker(c.f. <code class="docutils literal notranslate"><span class="pre">-v</span></code> option described previously), we can proceed with wheels building.
There is a build script which loops over available pythons in the Docker image under <code class="docutils literal notranslate"><span class="pre">/opt/python</span></code>, and then builds and audits the generated wheels.
Wheels are generated under <code class="docutils literal notranslate"><span class="pre">/root/nrn/wheelhouse</span></code> and also accessible in the mounted NEURON folder from outside the Docker image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Working directory is /root/nrn</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> 
<span class="n">ls</span> <span class="o">-</span><span class="n">la</span> <span class="n">wheelhouse</span>
</pre></div>
</div>
<p>You can build the wheel for a specific python version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> <span class="mi">38</span>    <span class="c1"># 38 for Python v3.8</span>
</pre></div>
</div>
<p>To build wheels with GPU support you have to pass an additional argument:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">coreneuron</span></code> : build wheel with <code class="docutils literal notranslate"><span class="pre">CoreNEURON</span></code> support</li>
<li><code class="docutils literal notranslate"><span class="pre">coreneuron-gpu</span></code> : build wheel with <code class="docutils literal notranslate"><span class="pre">CoreNEURON</span></code> and <code class="docutils literal notranslate"><span class="pre">GPU</span></code> support</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> <span class="mi">38</span> <span class="n">coreneuron</span><span class="o">-</span><span class="n">gpu</span>

<span class="c1"># or</span>

<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">linux</span> <span class="mi">3</span><span class="o">*</span> <span class="n">coreneuron</span>
</pre></div>
</div>
<p>In the last example we are passing <code class="docutils literal notranslate"><span class="pre">3*</span></code> to build the wheels with <code class="docutils literal notranslate"><span class="pre">CoreNEURON</span></code> support for all python 3 versions.</p>
</div>
<div class="section" id="macos">
<h3>macOS<a class="headerlink" href="#macos" title="Permalink to this headline"></a></h3>
<p>As mentioned above, for macOS all dependencies have to be available on a system. You have to then clone NEURON repository and execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">nrn</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">build_wheels</span><span class="o">.</span><span class="n">bash</span> <span class="n">osx</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing-the-wheels">
<h2>Testing the wheels<a class="headerlink" href="#testing-the-wheels" title="Permalink to this headline"></a></h2>
<p>To test the generated wheels, you can do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># first arg is a python exe and second arg is the corresponding wheel</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.8</span> <span class="n">wheelhouse</span><span class="o">/</span><span class="n">NEURON</span><span class="o">-</span><span class="mf">7.8.0.236</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">macosx_10_9_x86_64</span><span class="o">.</span><span class="n">whl</span>

<span class="c1"># Or, you can provide the pypi url</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.8</span> <span class="s2">&quot;-i https://test.pypi.org/simple/NEURON==7.8.11.2&quot;</span>
</pre></div>
</div>
<div class="section" id="macos-considerations">
<h3>MacOS considerations<a class="headerlink" href="#macos-considerations" title="Permalink to this headline"></a></h3>
<p>On MacOS, launching <code class="docutils literal notranslate"><span class="pre">nrniv</span> <span class="pre">-python</span></code> or <code class="docutils literal notranslate"><span class="pre">special</span> <span class="pre">-python</span></code> can fail to load <code class="docutils literal notranslate"><span class="pre">neuron</span></code> module due to security restrictions.
For this specific purpose, please <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">SKIP_EMBEDED_PYTHON_TEST=true</span></code> before launching the tests.</p>
</div>
<div class="section" id="testing-on-bb5">
<h3>Testing on BB5<a class="headerlink" href="#testing-on-bb5" title="Permalink to this headline"></a></h3>
<p>On BB5, we can test CPU wheels with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">salloc</span> <span class="o">-</span><span class="n">A</span> <span class="n">proj16</span>  <span class="o">-</span><span class="n">N</span> <span class="mi">1</span> <span class="o">--</span><span class="n">ntasks</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">node</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="n">C</span> <span class="s2">&quot;cpu&quot;</span> <span class="o">--</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="n">p</span> <span class="n">interactive</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">unstable</span> <span class="n">python</span>
<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span><span class="mf">.7</span> <span class="n">wheelhouse</span><span class="o">/</span><span class="n">NEURON</span><span class="o">-</span><span class="mf">7.8.0.236</span><span class="o">-</span><span class="n">cp37</span><span class="o">-</span><span class="n">cp37m</span><span class="o">-</span><span class="n">manylinux1_x86_64</span><span class="o">.</span><span class="n">whl</span>
</pre></div>
</div>
<p>The GPU wheels can be also tested in same way on the CPU partition. In this case only pre-compiled binaries
like <code class="docutils literal notranslate"><span class="pre">nrniv</span></code> and <code class="docutils literal notranslate"><span class="pre">nrniv-core</span></code> are tested on  the CPU. In order to test full functionality of GPU wheels we need to
do the following:</p>
<ul class="simple">
<li>Allocate GPU node</li>
<li>Load NVHPC compiler</li>
<li>Launch <code class="docutils literal notranslate"><span class="pre">test_wheels.sh</span></code></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">salloc</span> <span class="o">-</span><span class="n">A</span> <span class="n">proj16</span> <span class="o">-</span><span class="n">N</span> <span class="mi">1</span> <span class="o">--</span><span class="n">ntasks</span><span class="o">-</span><span class="n">per</span><span class="o">-</span><span class="n">node</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="n">C</span> <span class="s2">&quot;volta&quot;</span> <span class="o">--</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">-</span><span class="n">p</span> <span class="n">prod</span> <span class="o">--</span><span class="n">partition</span><span class="o">=</span><span class="n">prod</span> <span class="o">--</span><span class="n">exclusive</span>
<span class="n">module</span> <span class="n">load</span> <span class="n">unstable</span> <span class="n">python</span> <span class="n">nvhpc</span>

<span class="n">bash</span> <span class="n">packaging</span><span class="o">/</span><span class="n">python</span><span class="o">/</span><span class="n">test_wheels</span><span class="o">.</span><span class="n">sh</span> <span class="n">python3</span> <span class="n">NEURON_gpu_nightly</span><span class="o">-</span><span class="mf">8.0</span><span class="n">a709</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">cp38</span><span class="o">-</span><span class="n">manylinux_2_17_x86_64</span><span class="o">.</span><span class="n">manylinux2014_x86_64</span><span class="o">.</span><span class="n">whl</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">test_wheels.sh</span></code> will check if <code class="docutils literal notranslate"><span class="pre">nvc/nvc++</span></code> compilers are available and run tests for <code class="docutils literal notranslate"><span class="pre">hpe-mpi</span></code>, <code class="docutils literal notranslate"><span class="pre">intel-mpi</span></code> and <code class="docutils literal notranslate"><span class="pre">mvapich2</span></code> MPI modules.
Also, it checks if GPU is available (using <code class="docutils literal notranslate"><span class="pre">pgaccelinfo</span> <span class="pre">-nvidia</span></code> command) and then runs a few tests on the GPU as well.</p>
<p>Similar to BB5, the wheel can be tested on any desktop system provided that NVHPC compiler module is loaded or appropriate PATH environment variable is setup.</p>
</div>
</div>
<div class="section" id="publishing-the-wheels-on-pypi-via-azure">
<h2>Publishing the wheels on Pypi via Azure<a class="headerlink" href="#publishing-the-wheels-on-pypi-via-azure" title="Permalink to this headline"></a></h2>
<div class="section" id="official-release-wheels">
<h3>Official Release wheels<a class="headerlink" href="#official-release-wheels" title="Permalink to this headline"></a></h3>
<p>Head over to the <a class="reference external" href="https://dev.azure.com/neuronsimulator/nrn/_build?definitionId=1">neuronsimulator.nrn</a> pipeline on Azure.</p>
<p>After creating the tag on the <code class="docutils literal notranslate"><span class="pre">release/x.y</span></code> or on the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch, perform the following steps:</p>
<ol>
<li><p class="first">Click on <code class="docutils literal notranslate"><span class="pre">Run</span> <span class="pre">pipeline</span></code></p>
</li>
<li><p class="first">Input the release tag ref <code class="docutils literal notranslate"><span class="pre">refs/tags/x.y.z</span></code></p>
</li>
<li><p class="first">Click on <code class="docutils literal notranslate"><span class="pre">Variables</span></code></p>
</li>
<li><p class="first">We need to define three variables:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">NRN_NIGHTLY_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">NEURON_NIGHTLY_TAG</span></code> : undefined (leave empty)</li>
</ul>
<p>Do so by clicking <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">variable</span></code>, input the variable name and optionally the value and then click <code class="docutils literal notranslate"><span class="pre">Create</span></code>.</p>
</li>
<li><p class="first">Click on <code class="docutils literal notranslate"><span class="pre">Run</span></code></p>
</li>
</ol>
<p><img alt="../_images/azure-release-no-upload.png" src="../_images/azure-release-no-upload.png" /></p>
<p>With above, wheel will be created like release from the provided tag but they won’t be uploaded to the pypi.org ( as we have set  <code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD=false</span></code>). These wheels now you can download from artifacts section and perform thorough testing. Once you are happy with the testing result, set <code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code> and trigger the pipeline same way:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">NRN_NIGHTLY_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">true</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">NRN_RELEASE_UPLOAD</span></code> : <code class="docutils literal notranslate"><span class="pre">false</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">NEURON_NIGHTLY_TAG</span></code> : undefined (leave empty)</li>
</ul>
<p><img alt="../_images/azure-release.png" src="../_images/azure-release.png" /></p>
</div>
</div>
<div class="section" id="publishing-the-wheels-on-pypi-via-circleci">
<h2>Publishing the wheels on Pypi via CircleCI<a class="headerlink" href="#publishing-the-wheels-on-pypi-via-circleci" title="Permalink to this headline"></a></h2>
<p>Currently CircleCI doesn’t have automated pipeline for uploading <code class="docutils literal notranslate"><span class="pre">release</span></code> wheels to pypi.org (nightly wheels are uploaded automatically though). Currently we are using a <strong>hacky</strong>, semi-automated approach described below:</p>
<ul class="simple">
<li>Checkout your tag as a new branch</li>
<li>Update <code class="docutils literal notranslate"><span class="pre">.circleci/config.yml</span></code> as shown below</li>
<li>Trigger CI pipeline manually for <a class="reference external" href="https://app.circleci.com/pipelines/github/neuronsimulator/nrn">the nrn project</a></li>
<li>Upload wheels from artifacts manually</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># checkout release tag as a new branch
$ git checkout 8.1a -b release/8.1a-aarch64

# manually updated `.circleci/config.yml`
$ git diff

@@ -15,6 +15,10 @@ jobs:
     machine:
       image: ubuntu-2004:202101-01
+    environment:
+      NEURON_WHEEL_VERSION: 8.1a
+      NEURON_NIGHTLY_TAG: &quot;&quot;
+      NRN_NIGHTLY_UPLOAD: false
+      NRN_RELEASE_UPLOAD: false

@@ -89,7 +95,7 @@ workflows:
       - manylinux2014-aarch64:
           matrix:
             parameters:
-              NRN_PYTHON_VERSION: [&quot;310&quot;]
+              NRN_PYTHON_VERSION: [&quot;37&quot;, &quot;38&quot;, &quot;39&quot;, &quot;310&quot;]
</pre></div>
</div>
<p>The reason we are setting <code class="docutils literal notranslate"><span class="pre">NEURON_WHEEL_VERSION</span></code> to a desired version <code class="docutils literal notranslate"><span class="pre">8.1a</span></code> because <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> uses <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">describe</span></code> and it will give different version name as we are now on a new branch!</p>
<div class="section" id="nightly-wheels">
<h3>Nightly wheels<a class="headerlink" href="#nightly-wheels" title="Permalink to this headline"></a></h3>
<p>Nightly wheels get automatically published from <code class="docutils literal notranslate"><span class="pre">master</span></code> in CRON mode.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mac_pkg.html" class="btn btn-neutral float-left" title="Mac Binary Package (Apple M1 and Mac x86_64)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="code_coverage.html" class="btn btn-neutral float-right" title="Code Coverage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Duke, Yale and the Blue Brain Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>